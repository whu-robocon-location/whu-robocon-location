#include "PositionCount.h"

/*****************************************************************/
float x_del;				   	//定位坐标X增量
float y_del;				   	//定位坐・标Y增量
float a_del;            //定位坐标角度增量
float Gyro_angle_delta = 0;
extern int ANGLE_FLAG;

POSITION Position_Now	= 	{-0.1829103,-4.943582,0,0,0};       //码盘坐标(cm)
POSITION Position 	  	= 	{0,0,0,0,0,0};	       //大车坐标
POSITION Position_Last 	= 	{0,0,0,0,0,0};	       //大车上一次解算坐标
SPEED Speed_Now 	 	= 	{0,0,0,0};
SPEED Speed_temp 	  	= 	{0,0,0,0};

int    zp_now_position = 0;//零点目前所在位置
double zp_sum = 0;
double zp_data[MAX_ZP_SAMPLE] = {0};
double angle=0;
double filted_rate=0;
u8 	   init_flag =0;
/****************************标定参数*************************************/
float POS_SCALE = 3359.21005159662;					/* VG103 陀螺仪正向转的积分系数*/
float NEG_SCALE	= 3359.21005159662;

float POS_CM_PER_CNT_1 = 0.004019411;
float POS_CM_PER_CNT_2 = 0.00400647;
float NEG_CM_PER_CNT_1 = 0.004021005;
float NEG_CM_PER_CNT_2 = 0.004005201;
float CM_PER_CNT_1 = 0.004019411;
float CM_PER_CNT_2 = 0.00400647;

float OO_distance	=	 4.9469645;//4.955732;//4.891343;								//底盘中心到码盘中心的距离（cm）
float Angle_XX 		=	0.784296619;									//弧度制（β）	 
float Angle_OO 		= 	-1.607779;//-1.591452;//-1.570796;			            //弧度制（α）   

float mp_angle_wrong = 0.004457517;//0.004374746;//0.00436968860244446						//弧度

float SCALE_TAB[1401] = {
3359.21005159662,
3359.21626141401,
3359.22247123139,
3359.22571223704,
3359.22904397398,
3359.23246644223,
3359.23597964177,
3359.23958357262,
3359.24327823477,
3359.24706362822,
3359.25093975296,
3359.25490660901,
3359.25896419636,
3359.26311251502,
3359.26735156497,
3359.27168134622,
3359.27610185877,
3359.28061310263,
3359.28521507778,
3359.28990778424,
3359.29469122199,
3359.29956539105,
3359.30453029141,
3359.30958592307,
3359.31473228603,
3359.31996938029,
3359.32529720585,
3359.33071576271,
3359.33622505087,
3359.34182507034,
3359.3475158211,
3359.35329730317,
3359.35916951653,
3359.3651324612,
3359.37118613717,
3359.37733054443,
3359.383565683,
3359.38989155287,
3359.39630815404,
3359.40281548651,
3359.40941355028,
3359.41610234536,
3359.42288187173,
3359.4297521294,
3359.43671311838,
3359.44376483865,
3359.45090729023,
3359.45814047311,
3359.46546438729,
3359.47287903276,
3359.48038440954,
3359.48798051762,
3359.49566735701,
3359.50344492769,
3359.51131322967,
3359.51927226295,
3359.52732202754,
3359.53546252342,
3359.54369375061,
3359.55201570909,
3359.56042839888,
3359.56893181997,
3359.57752597236,
3359.58621085604,
3359.59498647104,
3359.60385281733,
3359.61280989492,
3359.62185770381,
3359.630996244,
3359.6402255155,
3359.64954551829,
3359.65895625239,
3359.66845771778,
3359.67804991448,
3359.68773284248,
3359.69750650178,
3359.70737089238,
3359.71732601427,
3359.72737186748,
3359.73750845198,
3359.74773576778,
3359.75805381488,
3359.76846259329,
3359.77896210299,
3359.789552344,
3359.8002333163,
3359.81100501991,
3359.82186745482,
3359.83282062103,
3359.84386451853,
3359.85499914734,
3359.86622450745,
3359.87754059887,
3359.88894742158,
3359.90044497559,
3359.9120332609,
3359.92371227752,
3359.93548202543,
3359.94734250465,
3359.95929371517,
3359.97133565699,
3359.9834683301,
3359.99569173452,
3360.00800587024,
3360.02041073726,
3360.03290633558,
3360.04549266521,
3360.05816972613,
3360.07093751835,
3360.08379604188,
3360.0967452967,
3360.10978528283,
3360.12291600025,
3360.13613744898,
3360.14944962901,
3360.16285254034,
3360.17634618297,
3360.1899305569,
3360.20360566213,
3360.21737149866,
3360.2312280665,
3360.24517536563,
3360.25921339606,
3360.2733421578,
3360.28756165083,
3360.30187187517,
3360.31627283081,
3360.33076451775,
3360.34534693599,
3360.36002008552,
3360.37478396637,
3360.38963857851,
3360.40458392195,
3360.41961999669,
3360.43474680273,
3360.44996434008,
3360.46527260872,
3360.48067160867,
3360.49616133992,
3360.51174180246,
3360.52741299631,
3360.54317492146,
3360.55902757791,
3360.57497096566,
3360.59100508471,
3360.60712993506,
3360.62334551672,
3360.63965182967,
3360.65604887392,
3360.67253664948,
3360.68911515633,
3360.70578439449,
3360.72254436395,
3360.73939506471,
3360.75633649676,
3360.77336866012,
3360.79049155478,
3360.80770518074,
3360.82500953801,
3360.84240462657,
3360.85989044643,
3360.8774669976,
3360.89513428006,
3360.91289229383,
3360.93074103889,
3360.94868051526,
3360.96671072293,
3360.9848316619,
3361.00304333217,
3361.02134573374,
3361.03973886661,
3361.05822273078,
3361.07679732625,
3361.09546265302,
3361.1142187111,
3361.13306550047,
3361.15200302115,
3361.17103127313,
3361.1901502564,
3361.20935997098,
3361.22866041686,
3361.24805159404,
3361.26753350252,
3361.2871061423,
3361.30676951338,
3361.32652361576,
3361.34636844945,
3361.36630401443,
3361.38633031071,
3361.4064473383,
3361.42665509719,
3361.44695358737,
3361.46734280886,
3361.48782276165,
3361.50839344574,
3361.52905486113,
3361.54980700782,
3361.57064988581,
3361.5915834951,
3361.6126078357,
3361.63372290759,
3361.65492871078,
3361.67622524528,
3361.69761251108,
3361.71909050817,
3361.74065923657,
3361.76231869627,
3361.78406888727,
3361.80590980957,
3361.82784146317,
3361.84986384807,
3361.87197696427,
3361.89418081178,
3361.91647539058,
3361.93886070068,
3361.96133674209,
3361.98390351479,
3362.0065610188,
3362.02930925411,
3362.05214822072,
3362.07507791863,
3362.09809834784,
3362.12120950835,
3362.14441140016,
3362.16770402327,
3362.19108737768,
3362.2145614634,
3362.23812628041,
3362.26178182873,
3362.28552810834,
3362.30936511926,
3362.33329286148,
3362.35731133499,
3362.38142053981,
3362.40562047593,
3362.42991114335,
3362.45429254208,
3362.4787646721,
3362.50332753342,
3362.52798112604,
3362.55272544997,
3362.57756050519,
3362.60248629172,
3362.62750280955,
3362.65261005867,
3362.6778080391,
3362.70309675083,
3362.72847619386,
3362.75394636819,
3362.77950727382,
3362.80515891075,
3362.83090127899,
3362.85673437852,
3362.88265820935,
3362.90867277149,
3362.93477806492,
3362.96097408966,
3362.9872608457,
3363.01363833304,
3363.04010655168,
3363.06666550162,
3363.09331518286,
3363.1200555954,
3363.14688673924,
3363.17380861438,
3363.20082122083,
3363.22792455857,
3363.25511862761,
3363.28240342796,
3363.30977895961,
3363.33724522255,
3363.3648022168,
3363.39244994235,
3363.4201883992,
3363.44801758735,
3363.4759375068,
3363.50394815755,
3363.53204953961,
3363.56024165296,
3363.58852449761,
3363.61689807357,
3363.64536238082,
3363.67391741938,
3363.70256318924,
3363.73129969039,
3363.76012692285,
3363.78904488661,
3363.81805358167,
3363.84715300803,
3363.8763431657,
3363.90562405466,
3363.93499567492,
3363.96445802649,
3363.99401110935,
3364.02365492352,
3364.05338946898,
3364.08321474575,
3364.11313075382,
3364.14313749319,
3364.17323496386,
3364.20342316583,
3364.2337020991,
3364.26407176367,
3364.29453215954,
3364.32508328671,
3364.35572514519,
3364.38645773496,
3364.41728105604,
3364.44819510841,
3364.47919989209,
3364.51029540707,
3364.54148165335,
3364.57275863093,
3364.60412633981,
3364.63558477999,
3364.66713395147,
3364.69877385425,
3364.73050448833,
3364.76232585372,
3364.7942379504,
3364.82624077839,
3364.85833433767,
3364.89051862826,
3364.92279365015,
3364.95515940334,
3364.98761588783,
3365.02016310362,
3365.05280105071,
3365.0855297291,
3365.11834913879,
3365.15125927978,
3365.18426015208,
3365.21735175567,
3365.25053409057,
3365.28380715676,
3365.31717095426,
3365.35062548306,
3365.38417074316,
3365.41780673456,
3365.45153345725,
3365.48535091126,
3365.51925909656,
3365.55325801316,
3365.58734766106,
3365.62152804027,
3365.65579915077,
3365.69016099258,
3365.72461356568,
3365.75915687009,
3365.7937909058,
3365.8285156728,
3365.86333117111,
3365.89823740072,
3365.93323436163,
3365.96832205384,
3366.00350047736,
3366.03876963217,
3366.07412951828,
3366.1095801357,
3366.14512148441,
3366.18075356443,
3366.21647637575,
3366.25228991836,
3366.28819419228,
3366.3241891975,
3366.36027493402,
3366.39645140184,
3366.43271860096,
3366.46907653138,
3366.50552519311,
3366.54206458613,
3366.57869471045,
3366.61541556608,
3366.652227153,
3366.68912947123,
3366.72612252076,
3366.76320630159,
3366.80038081372,
3366.83764605715,
3366.87500203188,
3366.91244873791,
3366.94998617524,
3366.98761434387,
3367.0253332438,
3367.06314287504,
3367.10104323757,
3367.13903433141,
3367.17711615655,
3367.21528871298,
3367.25355200072,
3367.29190601976,
3367.3303507701,
3367.36888625174,
3367.40751246468,
3367.44622940892,
3367.48503708447,
3367.52393549131,
3367.56292462945,
3367.6020044989,
3367.64117509964,
3367.68043643169,
3367.71978849504,
3367.75923128968,
3367.79876481563,
3367.83838907288,
3367.87810406143,
3367.91790978128,
3367.95780623244,
3367.99779341489,
3368.03787132864,
3368.0780399737,
3368.11829935005,
3368.15864945771,
3368.19909029666,
3368.23962186692,
3368.28024416848,
3368.32095720134,
3368.3617609655,
3368.40265546096,
3368.44364068772,
3368.48471664578,
3368.52588333514,
3368.5671407558,
3368.60848890777,
3368.64992779103,
3368.6914574056,
3368.73307775146,
3368.77478882863,
3368.8165906371,
3368.85848317687,
3368.90046644794,
3368.94254045031,
3368.98470518398,
3369.02696064895,
3369.06930684522,
3369.1117437728,
3369.15427143167,
3369.19688982184,
3369.23959894332,
3369.2823987961,
3369.32528938017,
3369.36827069555,
3369.41134274223,
3369.45450552021,
3369.49775902949,
3369.54110327007,
3369.58453824195,
3369.62806394513,
3369.67168037962,
3369.7153875454,
3369.75918544248,
3369.80307407087,
3369.84705343055,
3369.89112352154,
3369.93528434383,
3369.97953589742,
3370.02387818231,
3370.0683111985,
3370.11283494599,
3370.15744942478,
3370.20215463487,
3370.24695057626,
3370.29183724896,
3370.33681465295,
3370.38188278825,
3370.42704165484,
3370.47229125274,
3370.51763158194,
3370.56306264244,
3370.60858443424,
3370.65419695733,
3370.69990021174,
3370.74569419744,
3370.79157891444,
3370.83755436274,
3370.88362054235,
3370.92977745325,
3370.97602509546,
3371.02236346896,
3371.06879257377,
3371.11531240988,
3371.16192297728,
3371.20862427599,
3371.255416306,
3371.30229906731,
3371.34927255992,
3371.39633678384,
3371.44349173905,
3371.49073742556,
3371.53807384338,
3371.58550099249,
3371.63301887291,
3371.68062748462,
3371.72832682764,
3371.77611690196,
3371.82399770758,
3371.8719692445,
3371.92003151272,
3371.96818451224,
3372.01642824306,
3372.06476270518,
3372.11318789861,
3372.16170382333,
3372.21031047936,
3372.25900786668,
3372.30779598531,
3372.35667483524,
3372.40564441647,
3372.45470472899,
3372.50385577282,
3372.55309754795,
3372.60243005439,
3372.65185329212,
3372.70136726115,
3372.75097196148,
3372.80066739312,
3372.85045355605,
3372.90033045029,
3372.95029807582,
3373.00035643266,
3373.0505055208,
3373.10074534024,
3373.15107589098,
3373.20149717302,
3373.25200918636,
3373.302611931,
3373.35330540694,
3373.40408961419,
3373.45496455273,
3373.50593022258,
3373.55698662372,
3373.60813375617,
3373.65937161991,
3373.71070021496,
3373.76211954131,
3373.81362959896,
3373.86523038791,
3373.91692190816,
3373.96870415971,
3374.02057714257,
3374.07254085672,
3374.12459530217,
3374.17674047893,
3374.22897638698,
3374.28130302634,
3374.333720397,
3374.38622849895,
3374.43882733221,
3374.49151689677,
3374.54429719263,
3374.59716821979,
3374.65012997826,
3374.70318246802,
3374.75632568908,
3374.80955964145,
3374.86288432511,
3374.91629974007,
3374.96980588634,
3375.02340276391,
3375.07709037278,
3375.13086871294,
3375.18473778441,
3375.23869758718,
3375.29274812125,
3375.34688938663,
3375.4011213833,
3375.45544411127,
3375.50985757055,
3375.56436176112,
3375.618956683,
3375.67364233617,
3375.72841872065,
3375.78328583643,
3375.8382436835,
3375.89329226188,
3375.94843157156,
3376.00366161254,
3376.05898238483,
3376.11439388841,
3376.16989612329,
3376.22548908947,
3376.28117278696,
3376.33694721574,
3376.39281237583,
3376.44876826722,
3376.5048148899,
3376.56095224389,
3376.61718032918,
3376.67349914577,
3376.72990869366,
3376.78640897285,
3376.84299998334,
3376.89968172514,
3376.95645419823,
3377.01331740263,
3377.07027133832,
3377.12731600532,
3377.18445140362,
3377.24167753321,
3377.29899439411,
3377.35640198631,
3377.41390030981,
3377.47148936461,
3377.52916915071,
3377.58693966811,
3377.64480091682,
3377.70275289682,
3377.76079560812,
3377.81892905073,
3377.87715322464,
3377.93546812984,
3377.99387376635,
3378.05237013416,
3378.11095723327,
3378.16963506368,
3378.22840362539,
3378.2872629184,
3378.34621294271,
3378.40525369832,
3378.46438518524,
3378.52360740345,
3378.58292035297,
3378.64232403378,
3378.7018184459,
3378.76140358932,
3378.82107946403,
3378.88084607005,
3378.94070340737,
3379.00065147599,
3379.06069027591,
3379.12081980714,
3379.18104006966,
3379.24135106348,
3379.30175278861,
3379.36224524503,
3379.42282843276,
3379.48350235178,
3379.54426700211,
3379.60512238374,
3379.66606849667,
3379.7271053409,
3379.78823291643,
3379.84945122326,
3379.91076026139,
3379.97216003082,
3380.03365053155,
3380.09523176359,
3380.15690372692,
3380.21866642156,
3380.2805198475,
3380.34246400473,
3380.40449889327,
3380.46662451311,
3380.52884086425,
3380.59114794669,
3380.65354576043,
3380.71603430547,
3380.77861358182,
3380.84128358946,
3380.9040443284,
3380.96689579865,
3381.02983800019,
3381.09287093304,
3381.15599459719,
3381.21920899263,
3381.28251411938,
3381.34590997743,
3381.40939656678,
3381.47297388743,
3381.53664193938,
3381.60040072264,
3381.66425023719,
3381.72819048304,
3381.7922214602,
3381.85634316865,
3381.92055560841,
3381.98485877947,
3382.04925268183,
3382.11373731548,
3382.17831268044,
3382.2429787767,
3382.30773560426,
3382.37258316313,
3382.43752145329,
3382.50255047475,
3382.56767022752,
3382.63288071158,
3382.69818192694,
3382.76357387361,
3382.82905655158,
3382.89462996085,
3382.96029410142,
3383.02604897328,
3383.09189457645,
3383.15783091092,
3383.2238579767,
3383.28997577377,
3383.35618430214,
3383.42248356182,
3383.48887355279,
3383.55535427506,
3383.62192572864,
3383.68858791352,
3383.7553408297,
3383.82218447717,
3383.88911885595,
3383.95614396603,
3384.02325980741,
3384.0904663801,
3384.15776368408,
3384.22515171936,
3384.29263048594,
3384.36019998383,
3384.42786021301,
3384.4956111735,
3384.56345286529,
3384.63138528837,
3384.69940844276,
3384.76752232845,
3384.83572694544,
3384.90402229373,
3384.97240837332,
3385.04088518421,
3385.10945272641,
3385.1781109999,
3385.2468600047,
3385.31569974079,
3385.38463020819,
3385.45365140688,
3385.52276333688,
3385.59196599818,
3385.66125939078,
3385.73064351468,
3385.80011836988,
3385.86968395638,
3385.93934027418,
3386.00908732328,
3386.07892510369,
3386.14885361539,
3386.2188728584,
3386.2889828327,
3386.35918353831,
3386.42947497522,
3386.49985714343,
3386.57033004293,
3386.64089367374,
3386.71154803585,
3386.78229312927,
3386.85312895398,
3386.92405550999,
3386.9950727973,
3387.06618081592,
3387.13737956583,
3387.20866904705,
3387.28004925956,
3387.35152020338,
3387.4230818785,
3387.49473428492,
3387.56647742264,
3387.63831129166,
3387.71023589198,
3387.7822512236,
3387.85435728653,
3387.92655408075,
3387.99884160627,
3388.0712198631,
3388.14368885122,
3388.21624857065,
3388.28889902138,
3388.3616402034,
3388.43447211673,
3388.50739476136,
3388.58040813729,
3388.65351224452,
3388.72670708306,
3388.79999265289,
3388.87336895402,
3388.94683598646,
3389.02039375019,
3389.09404224523,
3389.16778147156,
3389.2416114292,
3389.31553211814,
3389.38954353838,
3389.46364568992,
3389.53783857276,
3389.6121221869,
3389.68649653234,
3389.76096160908,
3389.83551741712,
3389.91016395647,
3389.98490122711,
3390.05972922906,
3390.1346479623,
3390.20965742685,
3390.2847576227,
3390.35994854985,
3390.4352302083,
3390.51060259805,
3390.5860657191,
3390.66161957145,
3390.7372641551,
3390.81299947006,
3390.88882551631,
3390.96474229386,
3391.04074980271,
3391.11684804288,
3391.19303701433,
3391.26931671709,
3391.34568715115,
3391.42214831651,
3391.49870021317,
3391.57534284113,
3391.65207620039,
3391.72890029095,
3391.80581511282,
3391.88282066598,
3391.95991695044,
3392.03710396621,
3392.11438171328,
3392.19175019164,
3392.26920940131,
3392.34675934228,
3392.42440001455,
3392.50213141812,
3392.57995355299,
3392.65786641916,
3392.73587001663,
3392.81396434541,
3392.89214940548,
3392.97042519685,
3393.04879171953,
3393.1272489735,
3393.20579695878,
3393.28443567536,
3393.36316512324,
3393.44198530242,
3393.52089621289,
3393.59989785468,
3393.67899022776,
3393.75817333214,
3393.83744716782,
3393.91681173481,
3393.99626703309,
3394.07581306268,
3394.15544982356,
3394.23517731575,
3394.31499553924,
3394.39490449403,
3394.47490418011,
3394.5549945975,
3394.63517574619,
3394.71544762619,
3394.79581023748,
3394.87626358007,
3394.95680765396,
3395.03744245916,
3395.11816799565,
3395.19898426345,
3395.27989126255,
3395.36088899294,
3395.44197745464,
3395.52315664764,
3395.60442657194,
3395.68578722754,
3395.76723861444,
3395.84878073264,
3395.93041358215,
3396.01213716295,
3396.09395147505,
3396.17585651846,
3396.25785229317,
3396.33993879917,
3396.42211603648,
3396.50438400509,
3396.586742705,
3396.66919213621,
3396.75173229872,
3396.83436319253,
3396.91708481764,
3396.99989717405,
3397.08280026176,
3397.16579408078,
3397.24887863109,
3397.33205391271,
3397.41531992563,
3397.49867666984,
3397.58212414536,
3397.66566235218,
3397.7492912903,
3397.83301095972,
3397.91682136044,
3398.00072249246,
3398.08471435579,
3398.16879695041,
3398.25297027633,
3398.33723433356,
3398.42158912208,
3398.50603464191,
3398.59057089304,
3398.67519787546,
3398.75991558919,
3398.84472403422,
3398.92962321055,
3399.01461311818,
3399.09969375712,
3399.18486512735,
3399.27012722888,
3399.35548006172,
3399.44092362585,
3399.52645792129,
3399.61208294802,
3399.69779870606,
3399.7836051954,
3399.86950241604,
3399.95549036798,
3400.04156905122,
3400.12773846576,
3400.2139986116,
3400.30034948874,
3400.38679109718,
3400.47332343693,
3400.55994650797,
3400.64666031032,
3400.73346484396,
3400.82036010891,
3400.90734610516,
3400.99442283271,
3401.08159029156,
3401.16884848171,
3401.25619740316,
3401.34363705591,
3401.43116743996,
3401.51878855531,
3401.60650040197,
3401.69430297992,
3401.78219628918,
3401.87018032973,
3401.95825510159,
3402.04642060475,
3402.13467683921,
3402.22302380497,
3402.31146150203,
3402.39998993039,
3402.48860909005,
3402.57731898101,
3402.66611960327,
3402.75501095684,
3402.8439930417,
3402.93306585787,
3403.02222940533,
3403.1114836841,
3403.20082869417,
3403.29026443554,
3403.3797909082,
3403.46940811218,
3403.55911604745,
3403.64891471402,
3403.73880411189,
3403.82878424106,
3403.91885510154,
3404.00901669331,
3404.09926901639,
3404.18961207076,
3404.28004585644,
3404.37057037342,
3404.46118562169,
3404.55189160127,
3404.64268831215,
3404.73357575433,
3404.82455392782,
3404.9156228326,
3405.00678246868,
3405.09803283606,
3405.18937393475,
3405.28080576473,
3405.37232832602,
3405.46394161861,
3405.55564564249,
3405.64744039768,
3405.73932588417,
3405.83130210196,
3405.92336905105,
3406.01552673144,
3406.10777514313,
3406.20011428613,
3406.29254416042,
3406.38506476601,
3406.47767610291,
3406.57037817111,
3406.6631709706,
3406.7560545014,
3406.8490287635,
3406.9420937569,
3407.0352494816,
3407.1284959376,
3407.2218331249,
3407.3152610435,
3407.4087796934,
3407.50238907461,
3407.59608918711,
3407.68988003091,
3407.78376160602,
3407.87773391243,
3407.97179695013,
3408.06595071914,
3408.16019521945,
3408.25453045106,
3408.34895641397,
3408.44347310818,
3408.53808053369,
3408.63277869051,
3408.72756757862,
3408.82244719803,
3408.91741754875,
3409.01247863076,
3409.10763044408,
3409.2028729887,
3409.29820626462,
3409.39363027183,
3409.48914501035,
3409.58475048017,
3409.6804466813,
3409.77623361372,
3409.87211127744,
3409.96807967246,
3410.06413879879,
3410.16028865641,
3410.25652924534,
3410.35286056556,
3410.44928261709,
3410.54579539992,
3410.64239891405,
3410.73909315948,
3410.83587813621,
3410.93275384424,
3411.02972028357,
3411.1267774542,
3411.22392535614,
3411.32116398937,
3411.4184933539,
3411.51591344974,
3411.61342427688,
3411.71102583531,
3411.80871812505,
3411.90650114609,
3412.00437489843,
3412.10233938207,
3412.20039459701,
3412.29854054325,
3412.39677722079,
3412.49510462964,
3412.59352276978,
3412.69203164123,
3412.79063124397,
3412.88932157802,
3412.98810264336,
3413.08697444001,
3413.18593696796,
3413.28499022721,
3413.38413421776,
3413.48336893961,
3413.58269439276,
3413.68211057721,
3413.78161749297,
3413.88121514002,
3413.98090351838,
3414.08068262803,
3414.18055246899,
3414.28051304124,
3414.3805643448,
3414.48070637966,
3414.58093914582,
3414.68126264328,
3414.78167687204,
3414.8821818321,
3414.98277752346,
3415.08346394613,
3415.18424110009,
3415.28510898535,
3415.38606760192,
3415.48711694979,
3415.58825702895,
3415.68948783942,
3415.79080938119,
3415.89222165426,
3415.99372465863,
3416.0953183943,
3416.19700286127,
3416.29877805954,
3416.40064398911,
3416.50260064999,
3416.60464804216,
3416.70678616564,
3416.80901502041,
3416.91133460649,
3417.01374492387,
3417.11624597255,
3417.21883775252,
3417.3215202638,
3417.42429350638,
3417.52715748027,
3417.63011218545,
3417.73315762193,
3417.83629378972,
3417.9395206888,
3418.04283831918,
3418.14624668087,
3418.24974577386,
3418.35333559814,
3418.45701615373,
3418.56078744062,
3418.66464945881,
3418.7686022083,
3418.87264568909,
3418.97677990118,
3419.08100484458,
3419.18532051927,
3419.28972692527,
3419.39422406256,
3419.49881193116,
3419.60349053105,
3419.70825986225,
3419.81311992475,
3419.91807071855,
3420.02311224365,
3420.12824450005,
3420.23346748775,
3420.33878120675,
3420.44418565705,
3420.54968083866,
3420.65526675156,
3420.76094339576,
3420.86671077127,
3420.97256887808,
3421.07851771618,
3421.18455728559,
3421.2906875863,
3421.39690861831,
3421.50322038162,
3421.60962287623,
3421.71611610214,
3421.82270005936,
3421.92937474787,
3422.03614016768,
3422.1429963188,
3422.24994320121,
3422.35698081493,
3422.46410915995,
3422.57132823627,
3422.67863804388,
3422.7860385828,
3422.89352985302,
3423.00111185454,
3423.10878458737,
3423.21654805149,
3423.32440224691,
3423.43234717364,
3423.54038283166,
3423.64850922099,
3423.75672634161,
3423.86503419354,
3423.97343277677,
3424.0819220913,
3424.19050213713,
3424.29917291425,
3424.40793442269,
3424.51678666242,
3424.62572963345,
3424.73476333578,
3424.84388776942,
3424.95310293435,
3425.06240883059,
3425.17180545812,
3425.28129281696,
3425.3908709071,
3425.50053972854,
3425.61029928128,
3425.72014956532,
3425.83009058066,
3425.9401223273,
3426.05024480524,
3426.16045801448,
3426.27076195503,
3426.38115662687,
3426.49164203002,
3426.60221816446,
3426.71288503021,
3426.82364262726,
3426.93449095561,
3427.04543001526,
3427.15645980621,
3427.26758032846,
3427.37879158201,
3427.49009356686,
3427.60148628301,
3427.71296973047,
3427.82454390922,
3427.93620881928,
3428.04796446063,
3428.15981083329,
3428.27174793725,
3428.38377577251,
3428.49589433907,
3428.60810363693,
3428.72040366609,
3428.83279442655,
3428.94527591831,
3429.05784814137,
3429.17051109574,
3429.2832647814,
3429.39610919837,
3429.50904434663,
3429.6220702262,
3429.73518683707,
3429.84839417923,
3429.9616922527,
3430.07508105747,
3430.18856059354,
3430.30213086091,
3430.41579185959,
3430.52954358956,
3430.64338605083,
3430.75731924341,
3430.87134316728,
3430.98545782246,
3431.09966320893,
3431.21395932671,
3431.32834617579,
3431.44282375617,
3431.55739206785,
3431.67205111083,
3431.78680088511,
3431.90164139069,
3432.01657262758,
3432.13159459576,
3432.24670729524,
3432.36191072603,
3432.47720488811,
3432.5925897815,
3432.70806540619,
3432.82363176218,
3432.93928884946,
3433.05503666805,
3433.17087521795,
3433.28680449914,
3433.40282451163,
3433.51893525542,
3433.63513673051,
3433.75142893691,
3433.8678118746,
3433.9842855436,
3434.1008499439,
3434.21750507549,
3434.33425093839,
3434.45108753259,
3434.56801485809,
3434.68503291489,
3434.80214170299,
3434.91934122239,
3435.03663147309,
3435.1540124551,
3435.2714841684,
3435.38904661301,
3435.50669978891,
3435.62444369612,
3435.74227833463,
3435.86020370444,
3435.97821980554,
3436.09632663795,
3436.21452420166,
3436.33281249667,
3436.45119152299,
3436.5696612806,
3436.68822176951,
3436.80687298973,
3436.92561494124,
3437.04444762406,
3437.16337103817,
3437.28238518359,
3437.40149006031,
3437.52068566833,
3437.63997200765,
3437.75934907827,
3437.87881688019,
3437.99837541341,
3438.11802467793,
3438.23776467375,
3438.35759540088,
3438.4775168593,
3438.59752904903,
3438.71763197005,
3438.83782562238,
3438.95811000601,
3439.07848512094,
3439.19895096717,
3439.3195075447,
3439.44015485353,
3439.56089289366,
3439.68172166509,
3439.80264116782,
3439.92365140186,
3440.04475236719,
3440.16594406383,
3440.28722649177,
3440.408599651,
3440.53006354154,
3440.65161816338,
3440.77326351652,
3440.89499960096,
3441.0168264167,
3441.13874396374,
3441.26075224208,
3441.38285125172,
3441.50504099267,
3441.62732146491,
3441.74969266846,
3441.8721546033,
3441.99470726945,
3442.1173506669,
3442.24008479565,
3442.3629096557,
3442.48582524705,
3442.6088315697,
3442.73192862365,
3442.8551164089,
3442.97839492545,
3443.10176417331,
3443.22522415246,
3443.34877486292,
3443.47241630467,
3443.59614847773,
3443.71997138209,
3443.84388501775,
3443.9678893847,
3444.09198448297,
3444.21617031253,
3444.34044687339,
3444.46481416555,
3444.58927218901,
3444.71382094378,
3444.83846042984,
3444.9631906472,
3445.08801159587,
3445.21292327584,
3445.3379256871,
3445.46301882967,
3445.58820270354,
3445.71347730871,
3445.83884264518,
3445.96429871295,
3446.08984551203,
3446.2154830424,
3446.34121130407,
3446.46703029705,
3446.59294002132,
3446.7189404769,
3446.84503166377,
3446.97121358195,
3447.09748623143,
3447.22384961221,
3447.35030372429,
3447.47684856767,
3447.60348414235,
3447.73021044833,
3447.85702748561,
3447.9839352542,
3448.11093375408,
3448.23802298527,
3448.36520294775,
3448.49247364154,
3448.61983506663,
3448.74728722301,
3448.8748301107,
3449.00246372969,
3449.13018807998,
3449.25800316157,
3449.38590897447,
3449.51390551866,
3449.64199279415,
3449.77017080095,
3449.89843953904,
3450.02679900844,
3450.15524920913,
3450.28379014113,
3450.41242180443,
3450.54114419903,
3450.66995732493,
3450.79886118213,
3450.92785577063,
3451.05694109043,
3451.18611714153,
3451.31538392394,
3451.44474143764,
3451.57418968264,
3451.70372865895,
3451.83335836656,
3451.96307880546,
3452.09288997567,
3452.22279187718,
3452.35278450999,
};

/*****************************标定过程参数************************************/
//float msg_Angle_OO = 0;			 		//圆弧更新标定α
//float msg_OO_distance = 0;			//圆弧更新标定L

//float K1,K2,arc_K1,arc_K2;
//float angle_delta_max = 0;
/*****************************中间变量****************************************/
float course_sum_1 = 0; 
float course_sum_2 = 0;

float time = 0, time_last = 0, time_det = 0;
float speed_Vnow = 0,speed_Vlast = 0;
float Accelerated_Speed;
extern double Angular_Velocity;
/*****************************************************************/

void CountAngel(void)	//运行 146.25us
{
	if(comb_flt.comb_filter_flag == 2)							    //5us 执行时间IIR_input
	{
		kal_input	 = Angular_Velocity;
		kal_output = kalman_filter(&kal_filter,kal_input);				  //卡尔曼滤波,	加了一阶滞后滤波
		second_order_exkalman_output=second_order_exkalman_filter(&EXkal_filter,&second_order_flt,kal_input);//Angular_Velocity;//second_order_exkalman_filter(&EXkal_filter,&second_order_flt,kal_input);
		if(init_flag == 0)			//开机时先采集MAX_ZP_SAMPLE个数据，用于零点的更新
		{
			if(zp_now_position<(MAX_ZP_SAMPLE-1))
			{
				LED_RED_ON();
				LED_GREEN_OFF();
				zp_data[zp_now_position] = kal_output;
				zp_sum += zp_data[zp_now_position++];
			}
			else		/*初始化数完毕 init_flag置1*/
			{
				LED_RED_OFF();
				init_flag = 1;
				zp_data[zp_now_position] = kal_output;
				zp_sum  += zp_data[zp_now_position];
				kal_filter.zero_point = (float)(zp_sum/(MAX_ZP_SAMPLE));    /*初始化完成,零点第一次被更新 -- 取平均值，用卡尔曼滤波取静态的零点*/
			}
		}				
		else  	//首次零点更新完成
		{			
			cha = fabs(kal_output-kal_filter.zero_point);

			if( cha < ZERO_THREDHOLD)       //阈值内的值用于更新零点
			{
				if(zp_now_position<MAX_ZP_SAMPLE)
				{
					zp_sum -= zp_data[zp_now_position];
					zp_data[zp_now_position] = kal_output;
					zp_sum += zp_data[zp_now_position];
					kal_filter.zero_point = (float)(zp_sum/(MAX_ZP_SAMPLE));
					zp_now_position++;
				}				
				else
				{
					zp_now_position = 0;
					zp_sum = zp_sum-zp_data[zp_now_position];
					zp_data[zp_now_position] = kal_output ;
					zp_sum += zp_data[zp_now_position];
					kal_filter.zero_point =(float)(zp_sum/(MAX_ZP_SAMPLE));
					zp_now_position++;
				}			
			}
			else/*阈值外的值用于积分*/
			{	
				filted_rate = -(double)((second_order_exkalman_output- kal_filter.zero_point))*SAMP_TIME;		
				if(filted_rate > 0)	//正角速度
				{
				  POS_SCALE = 0.9997237 * SCALE_TAB[(int)(filted_rate * 10)];
					Gyro_angle_delta += filted_rate/(POS_SCALE);	
				}
				else  //负角速度
				{
					NEG_SCALE = 0.9995306 * SCALE_TAB[(int)(-filted_rate * 10)];
					Gyro_angle_delta += filted_rate/(NEG_SCALE);
				}
			}
		}
		ANGLE_FLAG++;
	}
}

void CountPosition(void)	//运行 135.59us
{	
	float Angle_delta;      													//姿态角增量
	float Angle1,Angle2;
	float Angle1_del,Angle2_del;												//用于寄存公用的三角函数运算值，减少重复计算
	float Angle1_cos,Angle1_sin,Angle2_cos,Angle2_sin;
	float Angle1_del_cos,Angle1_del_sin,Angle2_del_cos,Angle2_del_sin;
	float course_delta_1 = 0,course_delta_2 = 0 ;								//码盘1,2的距离增量	
	float AngleDeg_HuDu;														//姿态角
	AngleDeg_HuDu = Position_Now.AngleDeg * PI / 180;				//上一次的弧度 -- 角度变弧度
	Angle_delta = Gyro_angle_delta * PI / 180;					//变化的弧度 -- 角度变弧度
///*****************************仅计算阈值****************************************/
//	if(Gyro_angle_delta > angle_delta_max)
//			angle_delta_max = Gyro_angle_delta;	
///*****************************计算出来就删除****************************************/
	Position_Now.AngleDeg += Gyro_angle_delta;									//增量式更新姿态角
	a_del += Gyro_angle_delta;  
	Gyro_angle_delta = 0;  

	Encoder_Get_CNT();	//获取码盘 1 和码盘 2 的脉冲数
	
	if(DeltaCntEncoder1 > 0)
		CM_PER_CNT_1 = POS_CM_PER_CNT_1;	//转换为码盘 1 走过的路程
	else
		CM_PER_CNT_1 = NEG_CM_PER_CNT_1;	//转换为码盘 1 走过的路程
	if(DeltaCntEncoder2 > 0)
		CM_PER_CNT_2 = POS_CM_PER_CNT_2;	//转换为码盘 1 走过的路程
	else
		CM_PER_CNT_2 = NEG_CM_PER_CNT_2;	//转换为码盘 1 走过的路程
	
	course_delta_1 = CM_PER_CNT_1 * ((float)(DeltaCntEncoder1));	//转换为码盘 1 走过的路程
	course_delta_2 = CM_PER_CNT_2 * ((float)(DeltaCntEncoder2));	//转换为码盘 1 走过的路程
	course_sum_1 = CM_PER_CNT_1 * ((float)(Position_Now.Sum_Encoder1));
	course_sum_2 = CM_PER_CNT_2 * ((float)(Position_Now.Sum_Encoder2));
	
	Position_Now.Sum_Encoder1	+= DeltaCntEncoder1;			//增量式更新码盘 1 走过的总路程
	Position_Now.Sum_Encoder2	+= DeltaCntEncoder2;			//增量式更新码盘 2 走过的总路程
		
	Angle1 = Angle_XX + AngleDeg_HuDu;
	Angle1_cos = cos(Angle1);
	Angle1_sin = sin(Angle1);
	Angle2 = Angle_XX + AngleDeg_HuDu + mp_angle_wrong;
	Angle2_sin = sin(Angle2);
	Angle2_cos = cos(Angle2);	
	
	if(fabs(Angle_delta) < 0.0006) //直线更新,仅平动
	{
		x_del += course_delta_1*Angle1_cos - course_delta_2*Angle2_sin;
		y_del += course_delta_1*Angle1_sin + course_delta_2*Angle2_cos;
	}
	else
	{		
		Angle1_del = Angle1 + Angle_delta;
		Angle2_del = Angle2 + Angle_delta;
		Angle1_del_sin = sin(Angle1_del);
		Angle1_del_cos = cos(Angle1_del);
		Angle2_del_sin = sin(Angle2_del);
		Angle2_del_cos = cos(Angle2_del);
		
		x_del += (course_delta_1 * (Angle1_del_sin - Angle1_sin) + course_delta_2 * (Angle2_del_cos - Angle2_cos)) / (2 * sin(Angle_delta/2));	
		y_del += (-course_delta_1 * (Angle1_del_cos - Angle1_cos) + course_delta_2 * (Angle2_del_sin - Angle2_sin)) / (2 * sin(Angle_delta/2));
	
//		arc_K1 += (course_delta_1 * (Angle1_del_sin - Angle1_sin) + course_delta_2 * (Angle2_del_cos - Angle2_cos)) / (2 * sin(Angle_delta/2));
//		arc_K2 += (-course_delta_1 * (Angle1_del_cos - Angle1_cos) + course_delta_2 * (Angle2_del_sin - Angle2_sin)) / (2 * sin(Angle_delta/2));		
		
	}      
//	K1 = arc_K1 - (-0.050942);
//	K2 = arc_K2 - (-98.32000);
//	
//	msg_Angle_OO = atan(K2/K1);
//	msg_OO_distance = sqrt(K1*K1 + K2*K2)/2; 	
}
	

void CountSpeed(void)	//第一个速度值不要
{	
	float X_del,Y_del;
	float temp,temp_sin,temp_cos,ticks;	//用于寄存公用的三角函数运算值，减少重复计算	
	
	ticks = OSTimeGet();
	time = (float)ticks/10000.0f;    //tick_ms强制转化为float类型
	time_det = time - time_last;
	time_last = time;	
	
	Position_Now.X += x_del;
	Position_Now.Y += y_del; 

	temp = (Position_Now.AngleDeg)*PI/180+Angle_OO;
	temp_cos = cos(temp);
	temp_sin = sin(temp);
	
	Position_Last.X = Position.X;
	Position_Last.Y = Position.Y;
	Position.X = Position_Now.X - OO_distance*temp_cos;					//车的位置x坐标
	Position.Y = Position_Now.Y - OO_distance*temp_sin;					//车的位置y坐标
	Position.AngleDeg = Position_Now.AngleDeg;							//1ms 更新一次坐标
	
	X_del = Position.X - Position_Last.X;								//小车坐标增量
	Y_del = Position.Y - Position_Last.Y;
	
	Speed_Now.Vx = KAL_filter(&kalman_Vx,(double)(X_del/time_det));
	Speed_Now.Vy = KAL_filter(&kalman_Vy,(double)(Y_del/time_det));
	Speed_Now.Vw = KAL_filter(&kalman_Vw,(double)(a_del/time_det));
	Speed_Now.V = sqrt(Speed_Now.Vx*Speed_Now.Vx + Speed_Now.Vy*Speed_Now.Vy);
	Accelerated_Speed = KAL_filter(&kalman_Accelerate,(double)((speed_Vnow-speed_Vlast)/time_det));
  
	speed_Vlast = speed_Vnow;
	speed_Vnow = Speed_Now.V;
	
	x_del = 0;
	y_del = 0;
	a_del = 0;
}

void GYRO_Reset(void)
{
   __set_FAULTMASK(1); /*把FAULTMASK置位，即关闭所有的中断执行复位时不被中断打断*/
   NVIC_SystemReset();/*系统软件复位，配置好的外设寄存器也一起复位*/
}




