#include "PositionCount.h"

/*****************************************************************/
float x_del;				   	//定位坐标X增量
float y_del;				   	//定位坐标Y增量
float a_del;    //定位坐标角度增量
float Gyro_angle_delta = 0;
extern int ANGLE_FLAG;

POSITION Position_Now = {0,0,0,0,0};       //码盘坐标(cm)
POSITION Position 	  = {0,0,0,0,0};	       //大车坐标
POSITION Position_Last 	  = {0,0,0,0,0};	       //大车上一次解算坐标
SPEED Speed_Now 	  = {0,0,0,0};
SPEED Speed_temp 	  = {0,0,0,0};

int    zp_now_position = 0;//零点目前所在位置
double zp_sum = 0;
double zp_data[MAX_ZP_SAMPLE] = {0};
double angle=0;
double filted_rate=0;
u8 	   init_flag =0;
/****************************标定参数*************************************/
float POS_SCALE = 15634.995117;					/* VG910B 陀螺仪正向转的积分系数*/
float NEG_SCALE	= 15634.995117;                 	/* VG910B 陀螺仪反向转的积分系数*/

float POS_CM_PER_CNT_1 = 0.004012018;//0.004007726;
float POS_CM_PER_CNT_2 = 0.004010372;//0.004010810;
float NEG_CM_PER_CNT_1 = 0.00401628;//0.004012399;
float NEG_CM_PER_CNT_2 = 0.004012836;//0.004011061;
float CM_PER_CNT_1 = 0.004012018;//0.004007726;
float CM_PER_CNT_2 = 0.004010372;//0.004010810;

float OO_distance= 5.9335866;//5.88230753;//5.9335866;//5.8447957;//5.966356;//5.900518;//7.100781261;								//底盘中心到码盘中心的距离（cm）
float Angle_XX = -0.781403973;//-0.7853982;									//弧度制（β）	 
float Angle_OO = 0.914850116;//0.915553868;//914850116;//0.914554179;//0.924432;//0.9527787;//1.587559452;		            //弧度制（α）

float mp_angle_wrong = 0.002000626;//0;//0.002367481;//0.004374746;//0.00436968860244446						//弧度

float SCALE_TAB[1501] = {
15634.995117 ,
15634.988281 ,
15634.980469 ,
15634.970703 ,
15634.958984 ,
15634.945313 ,
15634.929688 ,
15634.913086 ,
15634.894531 ,
15634.874023 ,
15634.863281 ,
15634.851563 ,
15634.828125 ,
15634.801758 ,
15634.774414 ,
15634.745117 ,
15634.714844 ,
15634.681641 ,
15634.647461 ,
15634.611328 ,
15634.573242 ,
15634.534180 ,
15634.492188 ,
15634.449219 ,
15634.404297 ,
15634.358398 ,
15634.309570 ,
15634.259766 ,
15634.208008 ,
15634.154297 ,
15634.098633 ,
15634.041992 ,
15634.012695 ,
15633.982422 ,
15633.921875 ,
15633.860352 ,
15633.795898 ,
15633.730469 ,
15633.663086 ,
15633.593750 ,
15633.522461 ,
15633.449219 ,
15633.375000 ,
15633.298828 ,
15633.220703 ,
15633.140625 ,
15633.059570 ,
15632.976563 ,
15632.891602 ,
15632.804688 ,
15632.715820 ,
15632.625977 ,
15632.534180 ,
15632.440430 ,
15632.392578 ,
15632.344727 ,
15632.248047 ,
15632.148438 ,
15632.047852 ,
15631.945313 ,
15631.841797 ,
15631.735352 ,
15631.627930 ,
15631.518555 ,
15631.407227 ,
15631.294922 ,
15631.179688 ,
15631.063477 ,
15630.945313 ,
15630.825195 ,
15630.704102 ,
15630.581055 ,
15630.456055 ,
15630.329102 ,
15630.200195 ,
15630.070313 ,
15629.937500 ,
15629.871094 ,
15629.803711 ,
15629.667969 ,
15629.531250 ,
15629.392578 ,
15629.250977 ,
15629.108398 ,
15628.964844 ,
15628.818359 ,
15628.670898 ,
15628.521484 ,
15628.370117 ,
15628.216797 ,
15628.062500 ,
15627.906250 ,
15627.748047 ,
15627.587891 ,
15627.425781 ,
15627.262695 ,
15627.097656 ,
15626.930664 ,
15626.761719 ,
15626.676758 ,
15626.590820 ,
15626.418945 ,
15626.245117 ,
15626.069336 ,
15625.891602 ,
15625.712891 ,
15625.532227 ,
15625.349609 ,
15625.165039 ,
15624.978516 ,
15624.791016 ,
15624.601563 ,
15624.410156 ,
15624.216797 ,
15624.022461 ,
15623.825195 ,
15623.626953 ,
15623.426758 ,
15623.225586 ,
15623.021484 ,
15622.816406 ,
15622.609375 ,
15622.504883 ,
15622.400391 ,
15622.189453 ,
15621.977539 ,
15621.763672 ,
15621.547852 ,
15621.330078 ,
15621.111328 ,
15620.889648 ,
15620.666992 ,
15620.442383 ,
15620.216797 ,
15619.988281 ,
15619.758789 ,
15619.527344 ,
15619.293945 ,
15619.059570 ,
15618.822266 ,
15618.583984 ,
15618.343750 ,
15618.101563 ,
15617.858398 ,
15617.612305 ,
15617.365234 ,
15617.241211 ,
15617.116211 ,
15616.866211 ,
15616.613281 ,
15616.359375 ,
15616.103516 ,
15615.845703 ,
15615.586914 ,
15615.325195 ,
15615.062500 ,
15614.797852 ,
15614.531250 ,
15614.263672 ,
15613.994141 ,
15613.721680 ,
15613.449219 ,
15613.173828 ,
15612.896484 ,
15612.618164 ,
15612.337891 ,
15612.055664 ,
15611.772461 ,
15611.486328 ,
15611.199219 ,
15611.054688 ,
15610.910156 ,
15610.619141 ,
15610.327148 ,
15610.033203 ,
15609.737305 ,
15609.439453 ,
15609.139648 ,
15608.837891 ,
15608.535156 ,
15608.230469 ,
15607.923828 ,
15607.616211 ,
15607.305664 ,
15606.994141 ,
15606.680664 ,
15606.366211 ,
15606.048828 ,
15605.730469 ,
15605.410156 ,
15605.087891 ,
15604.763672 ,
15604.438477 ,
15604.110352 ,
15603.781250 ,
15603.616211 ,
15603.450195 ,
15603.118164 ,
15602.783203 ,
15602.447266 ,
15602.109375 ,
15601.770508 ,
15601.428711 ,
15601.085938 ,
15600.741211 ,
15600.394531 ,
15600.045898 ,
15599.696289 ,
15599.343750 ,
15598.990234 ,
15598.634766 ,
15598.278320 ,
15597.918945 ,
15597.558594 ,
15597.196289 ,
15596.832031 ,
15596.466797 ,
15596.099609 ,
15595.730469 ,
15595.359375 ,
15595.172852 ,
15594.986328 ,
15594.611328 ,
15594.235352 ,
15593.857422 ,
15593.477539 ,
15593.096680 ,
15592.712891 ,
15592.328125 ,
15591.941406 ,
15591.552734 ,
15591.163086 ,
15590.771484 ,
15590.376953 ,
15589.982422 ,
15589.584961 ,
15589.185547 ,
15588.785156 ,
15588.382813 ,
15587.978516 ,
15587.573242 ,
15587.165039 ,
15586.755859 ,
15586.344727 ,
15585.931641 ,
15585.517578 ,
15585.100586 ,
15584.892578 ,
15584.682617 ,
15584.262695 ,
15583.841797 ,
15583.417969 ,
15582.993164 ,
15582.566406 ,
15582.137695 ,
15581.708008 ,
15581.275391 ,
15580.841797 ,
15580.406250 ,
15579.968750 ,
15579.530273 ,
15579.088867 ,
15578.646484 ,
15578.202148 ,
15577.756836 ,
15577.308594 ,
15576.859375 ,
15576.408203 ,
15575.955078 ,
15575.500000 ,
15575.043945 ,
15574.585938 ,
15574.125977 ,
15573.664063 ,
15573.201172 ,
15572.735352 ,
15572.501953 ,
15572.268555 ,
15571.799805 ,
15571.330078 ,
15570.857422 ,
15570.383789 ,
15569.908203 ,
15569.430664 ,
15568.951172 ,
15568.470703 ,
15567.988281 ,
15567.503906 ,
15567.017578 ,
15566.529297 ,
15566.040039 ,
15565.548828 ,
15565.055664 ,
15564.560547 ,
15564.064453 ,
15563.566406 ,
15563.066406 ,
15562.564453 ,
15562.060547 ,
15561.555664 ,
15561.048828 ,
15560.540039 ,
15560.029297 ,
15559.516602 ,
15559.002930 ,
15558.487305 ,
15558.228516 ,
15557.969727 ,
15557.450195 ,
15556.929688 ,
15556.406250 ,
15555.881836 ,
15555.356445 ,
15554.828125 ,
15554.298828 ,
15553.766602 ,
15553.233398 ,
15552.699219 ,
15552.162109 ,
15551.624023 ,
15551.083984 ,
15550.541992 ,
15549.998047 ,
15549.452148 ,
15548.905273 ,
15548.356445 ,
15547.805664 ,
15547.253906 ,
15546.699219 ,
15546.143555 ,
15545.585938 ,
15545.026367 ,
15544.465820 ,
15543.902344 ,
15543.337891 ,
15542.771484 ,
15542.204102 ,
15541.633789 ,
15541.062500 ,
15540.489258 ,
15540.202148 ,
15539.914063 ,
15539.336914 ,
15538.758789 ,
15538.178711 ,
15537.596680 ,
15537.012695 ,
15536.427734 ,
15535.839844 ,
15535.250977 ,
15534.660156 ,
15534.067383 ,
15533.473633 ,
15532.877930 ,
15532.280273 ,
15531.680664 ,
15531.079102 ,
15530.476563 ,
15529.872070 ,
15529.265625 ,
15528.657227 ,
15528.046875 ,
15527.435547 ,
15526.822266 ,
15526.207031 ,
15525.589844 ,
15524.971680 ,
15524.350586 ,
15523.728516 ,
15523.104492 ,
15522.479492 ,
15521.851563 ,
15521.222656 ,
15520.591797 ,
15519.958984 ,
15519.325195 ,
15518.689453 ,
15518.050781 ,
15517.411133 ,
15517.090820 ,
15516.770508 ,
15516.126953 ,
15515.482422 ,
15514.835938 ,
15514.187500 ,
15513.537109 ,
15512.885742 ,
15512.232422 ,
15511.577148 ,
15510.919922 ,
15510.261719 ,
15509.600586 ,
15508.938477 ,
15508.274414 ,
15507.608398 ,
15506.941406 ,
15506.272461 ,
15505.601563 ,
15504.928711 ,
15504.253906 ,
15503.578125 ,
15502.899414 ,
15502.219727 ,
15501.539063 ,
15500.855469 ,
15500.170898 ,
15499.484375 ,
15498.795898 ,
15498.105469 ,
15497.414063 ,
15496.719727 ,
15496.024414 ,
15495.327148 ,
15494.628906 ,
15493.927734 ,
15493.225586 ,
15492.521484 ,
15491.815430 ,
15491.108398 ,
15490.398438 ,
15489.687500 ,
15488.974609 ,
15488.260742 ,
15487.543945 ,
15486.826172 ,
15486.106445 ,
15485.384766 ,
15484.661133 ,
15483.936523 ,
15483.573242 ,
15483.209961 ,
15482.481445 ,
15481.750977 ,
15481.018555 ,
15480.285156 ,
15479.549805 ,
15478.812500 ,
15478.073242 ,
15477.333008 ,
15476.589844 ,
15475.845703 ,
15475.099609 ,
15474.352539 ,
15473.602539 ,
15472.851563 ,
15472.098633 ,
15471.343750 ,
15470.587891 ,
15469.829102 ,
15469.069336 ,
15468.307617 ,
15467.544922 ,
15466.779297 ,
15466.012695 ,
15465.244141 ,
15464.473633 ,
15463.701172 ,
15462.927734 ,
15462.152344 ,
15461.375000 ,
15460.595703 ,
15459.814453 ,
15459.032227 ,
15458.248047 ,
15457.461914 ,
15456.673828 ,
15455.884766 ,
15455.092773 ,
15454.299805 ,
15453.504883 ,
15452.708984 ,
15451.910156 ,
15451.110352 ,
15450.308594 ,
15449.504883 ,
15448.700195 ,
15447.892578 ,
15447.083984 ,
15446.273438 ,
15445.461914 ,
15444.647461 ,
15443.832031 ,
15443.014648 ,
15442.195313 ,
15441.374023 ,
15440.551758 ,
15439.727539 ,
15438.901367 ,
15438.073242 ,
15437.243164 ,
15436.412109 ,
15435.579102 ,
15434.744141 ,
15433.907227 ,
15433.069336 ,
15432.228516 ,
15431.386719 ,
15430.542969 ,
15429.698242 ,
15428.850586 ,
15428.001953 ,
15427.151367 ,
15426.298828 ,
15425.445313 ,
15424.588867 ,
15423.731445 ,
15422.872070 ,
15422.010742 ,
15421.148438 ,
15420.284180 ,
15419.417969 ,
15418.549805 ,
15417.679688 ,
15416.808594 ,
15415.934570 ,
15415.059570 ,
15414.183594 ,
15413.304688 ,
15412.424805 ,
15411.542969 ,
15410.659180 ,
15409.773438 ,
15408.885742 ,
15407.997070 ,
15407.106445 ,
15406.213867 ,
15405.319336 ,
15404.423828 ,
15403.526367 ,
15402.626953 ,
15401.725586 ,
15400.822266 ,
15399.917969 ,
15399.011719 ,
15398.103516 ,
15397.193359 ,
15396.282227 ,
15395.368164 ,
15394.453125 ,
15393.536133 ,
15392.618164 ,
15391.697266 ,
15390.775391 ,
15389.851563 ,
15388.925781 ,
15387.999023 ,
15387.069336 ,
15386.138672 ,
15385.206055 ,
15384.272461 ,
15383.335938 ,
15382.398438 ,
15381.458984 ,
15380.517578 ,
15379.574219 ,
15378.629883 ,
15377.682617 ,
15376.734375 ,
15375.785156 ,
15374.833008 ,
15373.879883 ,
15372.924805 ,
15371.967773 ,
15371.008789 ,
15370.047852 ,
15369.085938 ,
15368.122070 ,
15367.156250 ,
15366.188477 ,
15365.219727 ,
15364.249023 ,
15363.276367 ,
15362.301758 ,
15361.325195 ,
15360.347656 ,
15359.368164 ,
15358.386719 ,
15357.403320 ,
15356.418945 ,
15355.431641 ,
15354.443359 ,
15353.453125 ,
15352.461914 ,
15351.467773 ,
15350.472656 ,
15349.475586 ,
15348.476563 ,
15347.476563 ,
15346.473633 ,
15345.469727 ,
15344.463867 ,
15343.456055 ,
15342.447266 ,
15341.436523 ,
15340.422852 ,
15339.409180 ,
15338.392578 ,
15337.374023 ,
15336.354492 ,
15335.333008 ,
15334.309570 ,
15333.285156 ,
15332.257813 ,
15331.229492 ,
15330.199219 ,
15329.167969 ,
15328.133789 ,
15327.098633 ,
15326.061523 ,
15325.022461 ,
15323.981445 ,
15322.939453 ,
15321.894531 ,
15320.848633 ,
15319.801758 ,
15318.751953 ,
15317.701172 ,
15316.648438 ,
15315.593750 ,
15314.537109 ,
15313.478516 ,
15312.418945 ,
15311.357422 ,
15310.293945 ,
15309.228516 ,
15308.162109 ,
15307.093750 ,
15306.023438 ,
15304.951172 ,
15303.876953 ,
15302.801758 ,
15301.724609 ,
15300.645508 ,
15298.481445 ,
15297.397461 ,
15296.311523 ,
15295.223633 ,
15294.133789 ,
15293.042969 ,
15291.950195 ,
15290.855469 ,
15289.758789 ,
15288.660156 ,
15287.560547 ,
15286.458984 ,
15285.355469 ,
15284.250000 ,
15283.143555 ,
15282.034180 ,
15280.923828 ,
15279.811523 ,
15278.698242 ,
15277.582031 ,
15276.464844 ,
15275.345703 ,
15274.224609 ,
15273.101563 ,
15271.977539 ,
15270.851563 ,
15269.723633 ,
15268.593750 ,
15267.462891 ,
15266.329102 ,
15265.194336 ,
15264.057617 ,
15262.919922 ,
15261.779297 ,
15260.637695 ,
15259.494141 ,
15258.348633 ,
15257.202148 ,
15256.052734 ,
15254.902344 ,
15252.595703 ,
15251.440430 ,
15250.282227 ,
15249.123047 ,
15247.961914 ,
15246.799805 ,
15245.634766 ,
15244.468750 ,
15243.300781 ,
15242.130859 ,
15240.959961 ,
15239.786133 ,
15238.611328 ,
15237.434570 ,
15236.255859 ,
15235.076172 ,
15233.894531 ,
15232.709961 ,
15231.525391 ,
15230.337891 ,
15229.148438 ,
15227.958008 ,
15226.765625 ,
15225.571289 ,
15224.375977 ,
15223.177734 ,
15221.978516 ,
15220.777344 ,
15219.574219 ,
15218.370117 ,
15215.955078 ,
15214.746094 ,
15213.534180 ,
15212.320313 ,
15211.105469 ,
15209.888672 ,
15208.669922 ,
15207.450195 ,
15206.227539 ,
15205.003906 ,
15203.778320 ,
15202.550781 ,
15201.322266 ,
15200.091797 ,
15198.858398 ,
15197.625000 ,
15196.388672 ,
15195.150391 ,
15193.911133 ,
15192.669922 ,
15191.426758 ,
15190.182617 ,
15188.935547 ,
15187.687500 ,
15186.437500 ,
15183.932617 ,
15182.676758 ,
15181.419922 ,
15180.161133 ,
15178.901367 ,
15177.638672 ,
15176.375000 ,
15175.109375 ,
15173.841797 ,
15172.573242 ,
15171.301758 ,
15170.029297 ,
15168.754883 ,
15167.478516 ,
15166.201172 ,
15164.920898 ,
15163.639648 ,
15162.356445 ,
15161.072266 ,
15159.785156 ,
15158.497070 ,
15155.915039 ,
15154.622070 ,
15153.326172 ,
15152.029297 ,
15150.730469 ,
15149.429688 ,
15148.127930 ,
15146.823242 ,
15145.517578 ,
15144.209961 ,
15142.901367 ,
15141.589844 ,
15140.277344 ,
15138.962891 ,
15137.646484 ,
15136.328125 ,
15135.008789 ,
15133.687500 ,
15132.364258 ,
15131.039063 ,
15129.712891 ,
15128.383789 ,
15127.053711 ,
15125.721680 ,
15124.388672 ,
15123.052734 ,
15121.715820 ,
15120.376953 ,
15119.036133 ,
15117.693359 ,
15116.349609 ,
15115.003906 ,
15113.656250 ,
15112.306641 ,
15110.955078 ,
15109.602539 ,
15108.248047 ,
15106.891602 ,
15105.533203 ,
15104.173828 ,
15102.812500 ,
15101.449219 ,
15100.083984 ,
15098.716797 ,
15097.348633 ,
15095.978516 ,
15094.606445 ,
15093.232422 ,
15091.856445 ,
15090.479492 ,
15089.100586 ,
15087.719727 ,
15086.336914 ,
15084.953125 ,
15083.566406 ,
15082.178711 ,
15080.790039 ,
15079.398438 ,
15078.005859 ,
15076.610352 ,
15075.213867 ,
15073.816406 ,
15072.416016 ,
15071.014648 ,
15069.611328 ,
15068.206055 ,
15066.798828 ,
15065.389648 ,
15063.979492 ,
15062.567383 ,
15061.153320 ,
15059.738281 ,
15058.320313 ,
15056.901367 ,
15055.480469 ,
15054.057617 ,
15052.633789 ,
15051.207031 ,
15049.779297 ,
15048.349609 ,
15046.918945 ,
15045.485352 ,
15044.050781 ,
15042.614258 ,
15041.175781 ,
15039.735352 ,
15038.293945 ,
15036.850586 ,
15035.405273 ,
15033.958008 ,
15032.509766 ,
15031.058594 ,
15029.606445 ,
15028.152344 ,
15026.696289 ,
15025.239258 ,
15023.780273 ,
15022.319336 ,
15020.856445 ,
15019.391602 ,
15017.925781 ,
15016.458008 ,
15014.988281 ,
15013.516602 ,
15012.042969 ,
15010.568359 ,
15009.091797 ,
15007.613281 ,
15006.132813 ,
15004.651367 ,
15003.166992 ,
15001.681641 ,
15000.195313 ,
14998.706055 ,
14997.214844 ,
14995.722656 ,
14994.228516 ,
14992.733398 ,
14991.235352 ,
14989.736328 ,
14988.234375 ,
14986.732422 ,
14985.227539 ,
14983.720703 ,
14982.212891 ,
14980.703125 ,
14979.191406 ,
14977.678711 ,
14976.163086 ,
14974.646484 ,
14973.127930 ,
14971.607422 ,
14970.085938 ,
14968.561523 ,
14967.036133 ,
14965.508789 ,
14963.980469 ,
14962.449219 ,
14960.916992 ,
14959.382813 ,
14957.846680 ,
14956.308594 ,
14954.769531 ,
14953.228516 ,
14951.685547 ,
14950.140625 ,
14948.593750 ,
14947.045898 ,
14945.496094 ,
14943.944336 ,
14942.390625 ,
14940.835938 ,
14939.278320 ,
14937.719727 ,
14936.159180 ,
14934.597656 ,
14933.033203 ,
14931.467773 ,
14929.900391 ,
14928.331055 ,
14926.760742 ,
14925.188477 ,
14923.613281 ,
14922.037109 ,
14920.459961 ,
14918.879883 ,
14917.298828 ,
14915.715820 ,
14914.130859 ,
14912.543945 ,
14910.956055 ,
14909.366211 ,
14907.774414 ,
14906.180664 ,
14904.584961 ,
14902.988281 ,
14901.389648 ,
14899.789063 ,
14898.186523 ,
14896.583008 ,
14894.977539 ,
14893.369141 ,
14891.760742 ,
14890.149414 ,
14888.537109 ,
14886.921875 ,
14885.305664 ,
14883.688477 ,
14882.068359 ,
14880.447266 ,
14878.823242 ,
14877.199219 ,
14875.572266 ,
14873.943359 ,
14872.313477 ,
14870.681641 ,
14869.047852 ,
14867.413086 ,
14865.775391 ,
14864.136719 ,
14862.496094 ,
14860.853516 ,
14859.209961 ,
14857.563477 ,
14855.916016 ,
14854.266602 ,
14852.615234 ,
14850.962891 ,
14849.308594 ,
14847.652344 ,
14845.994141 ,
14844.333984 ,
14842.672852 ,
14841.008789 ,
14839.343750 ,
14837.677734 ,
14836.008789 ,
14834.338867 ,
14832.666992 ,
14830.993164 ,
14829.317383 ,
14827.639648 ,
14825.960938 ,
14824.280273 ,
14822.597656 ,
14820.913086 ,
14819.227539 ,
14817.540039 ,
14815.850586 ,
14814.159180 ,
14812.465820 ,
14810.771484 ,
14809.075195 ,
14807.376953 ,
14805.676758 ,
14803.975586 ,
14802.272461 ,
14800.566406 ,
14798.860352 ,
14797.151367 ,
14795.441406 ,
14793.728516 ,
14792.014648 ,
14790.298828 ,
14788.582031 ,
14786.863281 ,
14785.141602 ,
14783.418945 ,
14781.695313 ,
14779.968750 ,
14778.241211 ,
14776.511719 ,
14774.780273 ,
14773.046875 ,
14771.312500 ,
14769.576172 ,
14767.837891 ,
14766.097656 ,
14764.355469 ,
14762.612305 ,
14760.867188 ,
14759.120117 ,
14757.371094 ,
14755.621094 ,
14753.868164 ,
14752.114258 ,
14750.358398 ,
14748.601563 ,
14746.841797 ,
14745.081055 ,
14743.318359 ,
14741.553711 ,
14739.788086 ,
14738.019531 ,
14736.250000 ,
14734.478516 ,
14732.706055 ,
14730.930664 ,
14729.154297 ,
14727.375977 ,
14725.595703 ,
14723.813477 ,
14722.030273 ,
14720.244141 ,
14718.457031 ,
14716.668945 ,
14714.877930 ,
14713.085938 ,
14711.291992 ,
14709.496094 ,
14707.698242 ,
14705.898438 ,
14704.097656 ,
14702.294922 ,
14700.490234 ,
14698.683594 ,
14696.875977 ,
14695.066406 ,
14693.254883 ,
14691.441406 ,
14689.625977 ,
14687.809570 ,
14685.991211 ,
14684.170898 ,
14682.348633 ,
14680.525391 ,
14678.699219 ,
14676.872070 ,
14675.042969 ,
14673.212891 ,
14671.379883 ,
14669.545898 ,
14667.709961 ,
14665.872070 ,
14664.033203 ,
14662.191406 ,
14660.348633 ,
14658.503906 ,
14656.657227 ,
14654.809570 ,
14652.959961 ,
14651.108398 ,
14649.254883 ,
14647.399414 ,
14645.542969 ,
14643.683594 ,
14641.823242 ,
14639.961914 ,
14638.097656 ,
14636.232422 ,
14634.364258 ,
14632.495117 ,
14630.625000 ,
14628.751953 ,
14626.877930 ,
14625.001953 ,
14623.124023 ,
14621.244141 ,
14619.363281 ,
14617.480469 ,
14615.595703 ,
14613.708984 ,
14611.820313 ,
14609.930664 ,
14608.039063 ,
14606.145508 ,
14604.250000 ,
14602.352539 ,
14600.454102 ,
14598.553711 ,
14596.651367 ,
14594.748047 ,
14592.841797 ,
14590.934570 ,
14589.025391 ,
14587.114258 ,
14585.201172 ,
14583.287109 ,
14581.371094 ,
14579.453125 ,
14577.533203 ,
14575.612305 ,
14573.688477 ,
14571.763672 ,
14569.836914 ,
14567.909180 ,
14565.978516 ,
14564.046875 ,
14562.113281 ,
14560.177734 ,
14558.241211 ,
14556.301758 ,
14554.361328 ,
14552.418945 ,
14550.474609 ,
14548.529297 ,
14546.582031 ,
14544.631836 ,
14542.681641 ,
14540.728516 ,
14538.773438 ,
14536.817383 ,
14534.859375 ,
14532.899414 ,
14530.938477 ,
14528.974609 ,
14527.009766 ,
14525.042969 ,
14523.075195 ,
14521.104492 ,
14519.132813 ,
14517.159180 ,
14515.183594 ,
14513.206055 ,
14511.227539 ,
14509.246094 ,
14507.263672 ,
14505.280273 ,
14503.293945 ,
14501.306641 ,
14499.316406 ,
14497.325195 ,
14495.333008 ,
14493.337891 ,
14491.341797 ,
14489.343750 ,
14487.343750 ,
14485.341797 ,
14483.338867 ,
14481.333008 ,
14479.326172 ,
14477.318359 ,
14475.307617 ,
14473.295898 ,
14471.281250 ,
14469.266602 ,
14467.249023 ,
14465.229492 ,
14463.208984 ,
14461.186523 ,
14459.162109 ,
14457.135742 ,
14455.108398 ,
14453.079102 ,
14451.047852 ,
14449.014648 ,
14446.979492 ,
14444.943359 ,
14442.905273 ,
14440.865234 ,
14438.823242 ,
14436.779297 ,
14434.734375 ,
14432.687500 ,
14430.638672 ,
14428.587891 ,
14426.536133 ,
14424.482422 ,
14422.426758 ,
14420.369141 ,
14418.309570 ,
14416.249023 ,
14414.186523 ,
14412.122070 ,
14410.055664 ,
14407.987305 ,
14405.917969 ,
14403.846680 ,
14401.773438 ,
14399.698242 ,
14397.622070 ,
14395.543945 ,
14393.463867 ,
14391.381836 ,
14389.297852 ,
14387.212891 ,
14385.125977 ,
14383.037109 ,
14380.946289 ,
14378.853516 ,
14376.759766 ,
14374.664063 ,
14372.566406 ,
14370.466797 ,
14368.366211 ,
14366.263672 ,
14364.159180 ,
14362.052734 ,
14359.944336 ,
14357.834961 ,
14355.723633 ,
14353.610352 ,
14351.495117 ,
14349.377930 ,
14347.259766 ,
14345.139648 ,
14343.017578 ,
14340.893555 ,
14338.768555 ,
14336.641602 ,
14334.512695 ,
14332.381836 ,
14330.249023 ,
14328.115234 ,
14325.979492 ,
14323.841797 ,
14321.702148 ,
14319.560547 ,
14317.417969 ,
14315.273438 ,
14313.126953 ,
14310.978516 ,
14308.829102 ,
14306.677734 ,
14304.524414 ,
14302.369141 ,
14300.211914 ,
14298.053711 ,
14295.893555 ,
14293.731445 ,
14291.567383 ,
14289.401367 ,
14287.234375 ,
14285.065430 ,
14282.894531 ,
14280.721680 ,
14278.547852 ,
14276.371094 ,
14274.193359 ,
14272.014648 ,
14269.833008 ,
14267.650391 ,
14265.464844 ,
14263.278320 ,
14261.090820 ,
14258.900391 ,
14256.708984 ,
14254.515625 ,
14252.320313 ,
14250.123047 ,
14247.924805 ,
14245.723633 ,
14243.521484 ,
14241.317383 ,
14239.112305 ,
14236.904297 ,
14234.695313 ,
14232.484375 ,
14230.272461 ,
14228.057617 ,
14225.841797 ,
14223.624023 ,
14221.404297 ,
14219.182617 ,
14216.958984 ,
14214.734375 ,
14212.507813 ,
14210.279297 ,
14208.049805 ,
14205.817383 ,
14203.583984 ,
14201.348633 ,
14199.111328 ,
14196.873047 ,
14194.632813 ,
14192.389648 ,
14190.146484 ,
14187.900391 ,
14185.652344 ,
14183.403320 ,
14181.152344 ,
14178.899414 ,
14176.645508 ,
14174.388672 ,
14172.130859 ,
14169.871094 ,
14167.609375 ,
14165.346680 ,
14163.081055 ,
14160.814453 ,
14158.545898 ,
14156.276367 ,
14154.003906 ,
14151.730469 ,
14149.455078 ,
14147.177734 ,
14144.898438 ,
14142.618164 ,
14140.335938 ,
14138.051758 ,
14135.765625 ,
14133.477539 ,
14131.188477 ,
14128.897461 ,
14126.604492 ,
14124.309570 ,
14122.013672 ,
14119.715820 ,
14117.416016 ,
14115.114258 ,
14112.810547 ,
14110.505859 ,
14108.199219 ,
14105.890625 ,
14103.580078 ,
14101.267578 ,
14098.954102 ,
14096.638672 ,
14094.321289 ,
14092.001953 ,
14089.681641 ,
14087.358398 ,
14085.034180 ,
14082.708984 ,
14080.380859 ,
14078.050781 ,
14075.719727 ,
14073.386719 ,
14071.052734 ,
14068.715820 ,
14066.377930 ,
14064.038086 ,
14061.696289 ,
14059.352539 ,
14057.006836 ,
14054.660156 ,
14052.311523 ,
14049.960938 ,
14047.609375 ,
14045.254883 ,
14042.899414 ,
14040.541992 ,
14038.182617 ,
14035.822266 ,
14033.458984 ,
14031.094727 ,
14028.728516 ,
14026.361328 ,
14023.991211 ,
14021.620117 ,
14019.247070 ,
14016.872070 ,
14014.495117 ,
14012.117188 ,
14009.737305 ,
14007.355469 ,
14004.971680 ,
14002.585938 ,
14000.199219 ,
13997.810547 ,
13995.419922 ,
13993.027344 ,
13990.633789 ,
13988.237305 ,
13985.839844 ,
13983.441406 ,
13981.040039 ,
13978.637695 ,
13976.232422 ,
13973.826172 ,
13971.418945 ,
13969.008789 ,
13966.597656 ,
13964.184570 ,
13961.769531 ,
13959.352539 ,
13956.933594 ,
13954.513672 ,
13952.091797 ,
13949.667969 ,
13947.243164 ,
13944.815430 ,
13942.386719 ,
13939.956055 ,
13937.523438 ,
13935.089844 ,
13932.653320 ,
13930.215820 ,
13927.776367 ,
13925.335938 ,
13922.892578 ,
13920.448242 ,
13918.001953 ,
13915.553711 ,
13913.103516 ,
13910.652344 ,
13908.199219 ,
13905.744141 ,
13903.287109 ,
13900.828125 ,
13898.368164 ,
13895.906250 ,
13893.442383 ,
13890.976563 ,
13888.509766 ,
13886.040039 ,
13883.569336 ,
13881.096680 ,
13878.623047 ,
13876.146484 ,
13873.668945 ,
13871.189453 ,
13868.708008 ,
13866.225586 ,
13863.740234 ,
13861.253906 ,
13858.765625 ,
13856.276367 ,
13853.784180 ,
13851.291016 ,
13848.795898 ,
13846.298828 ,
13843.799805 ,
13841.299805 ,
13838.797852 ,
13836.293945 ,
13833.788086 ,
13831.280273 ,
13828.771484 ,
13826.260742 ,
13823.748047 ,
13821.233398 ,
13818.717773 ,
13816.199219 ,
13813.679688 ,
13811.158203 ,
13808.635742 ,
13806.110352 ,
13803.583984 ,
13801.055664 ,
13798.525391 ,
13795.994141 ,
13793.460938 ,
13790.924805 ,
13788.387695 ,
13785.849609 ,
13783.308594 ,
13780.766602 ,
13778.222656 ,
13775.676758 ,
13773.128906 ,
13770.580078 ,
13768.029297 ,
13765.476563 ,
13762.921875 ,
13760.365234 ,
13757.807617 ,
13755.248047 ,
13752.686523 ,
13750.123047 ,
13747.558594 ,
13744.991211 ,
13742.422852 ,
13739.852539 ,
13737.281250 ,
13734.707031 ,
13732.131836 ,
13729.554688 ,
13726.975586 ,
13724.395508 ,
13721.812500 ,
13719.228516 ,
13716.642578 ,
13714.055664 ,
13711.465820 ,
13708.875000 ,
13706.282227 ,
13703.687500 ,
13701.090820 ,
13698.493164 ,
13695.893555 ,
};

/*****************************标定过程参数************************************/
float msg_Angle_OO = 0;			 		//圆弧更新标定α
float msg_OO_distance = 0;			//圆弧更新标定L

float K1,K2,arc_K1,arc_K2;
float angle_delta_max = 0;
/*****************************中间变量****************************************/
float course_sum_1 = 0; 
float course_sum_2 = 0;

float time = 0, time_last = 0, time_det = 0;
float speed_Vnow = 0,speed_Vlast = 0;
float Accelerated_Speed;
/*****************************************************************/

void CountAngel(void)	//运行 146.25us
{
	if(comb_flt.comb_filter_flag == 2)							    //5us 执行时间IIR_input
	{
		kal_input	 = combination_filter(&comb_flt);
		kal_output = kalman_filter(&kal_filter,kal_input);				  //卡尔曼滤波,	加了一阶滞后滤波
		second_order_exkalman_output=second_order_exkalman_filter(&EXkal_filter,&second_order_flt,kal_input);//Angular_Velocity;//second_order_exkalman_filter(&EXkal_filter,&second_order_flt,kal_input);
		if(init_flag == 0)			//开机时先采集MAX_ZP_SAMPLE个数据，用于零点的更新
		{
			if(zp_now_position<(MAX_ZP_SAMPLE-1))
			{
				LED_RED_ON();
				LED_GREEN_OFF();
				zp_data[zp_now_position] = kal_output;
				zp_sum += zp_data[zp_now_position++];
			}
			else		/*初始化数完毕 init_flag置1*/
			{
				LED_RED_OFF();
				init_flag = 1;
				zp_data[zp_now_position] = kal_output;
				zp_sum  += zp_data[zp_now_position];
				kal_filter.zero_point = (float)(zp_sum/(MAX_ZP_SAMPLE));    /*初始化完成,零点第一次被更新 -- 取平均值，用卡尔曼滤波取静态的零点*/
			}
		}				
		else  	//首次零点更新完成
		{			
			cha = fabs(kal_output-kal_filter.zero_point);

			if( cha < ZERO_THREDHOLD)       //阈值内的值用于更新零点
			{
				if(zp_now_position<MAX_ZP_SAMPLE)
				{
					zp_sum -= zp_data[zp_now_position];
					zp_data[zp_now_position] = kal_output;
					zp_sum += zp_data[zp_now_position];
					kal_filter.zero_point = (float)(zp_sum/(MAX_ZP_SAMPLE));
					zp_now_position++;
				}				
				else
				{
					zp_now_position = 0;
					zp_sum = zp_sum-zp_data[zp_now_position];
					zp_data[zp_now_position] = kal_output ;
					zp_sum += zp_data[zp_now_position];
					kal_filter.zero_point =(float)(zp_sum/(MAX_ZP_SAMPLE));
					zp_now_position++;
				}			
			}
			else/*阈值外的值用于积分*/
			{	
				filted_rate = -(double)((second_order_exkalman_output- kal_filter.zero_point))*SAMP_TIME;    //用卡尔曼滤波与二阶低通滤波结合处理动态问题		
				if(filted_rate > 0)	//正角速度
				{
					POS_SCALE = 0.9999899*SCALE_TAB[(int)(filted_rate)];
					Gyro_angle_delta += filted_rate/POS_SCALE;	
				}
				else  //负角速度
				{
					NEG_SCALE = 0.99944444*SCALE_TAB[(int)(-filted_rate)];
					Gyro_angle_delta += filted_rate/NEG_SCALE;
				}
			}
		}
		ANGLE_FLAG++;
	}
}

void CountPosition(void)	//运行 135.59us
{	
	float Angle_delta;      													//姿态角增量
	float Angle1,Angle2;
	float Angle1_del,Angle2_del;												//用于寄存公用的三角函数运算值，减少重复计算
	float Angle1_cos,Angle1_sin,Angle2_cos,Angle2_sin;
	float Angle1_del_cos,Angle1_del_sin,Angle2_del_cos,Angle2_del_sin;
	float course_delta_1 = 0,course_delta_2 = 0 ;								//码盘1,2的距离增量	
	float AngleDeg_HuDu;														//姿态角
	AngleDeg_HuDu = Position_Now.AngleDeg * PI / 180;				//上一次的弧度 -- 角度变弧度
	Angle_delta = Gyro_angle_delta * PI / 180;					//变化的弧度 -- 角度变弧度
	Position_Now.AngleDeg += Gyro_angle_delta;									//增量式更新姿态角
	a_del += Gyro_angle_delta;  
	Gyro_angle_delta = 0;  

	Encoder_Get_CNT();	//获取码盘 1 和码盘 2 的脉冲数
	
	if(DeltaCntEncoder1 > 0)
		CM_PER_CNT_1 = POS_CM_PER_CNT_1;	//转换为码盘 1 走过的路程
	else
		CM_PER_CNT_1 = NEG_CM_PER_CNT_1;	//转换为码盘 1 走过的路程
	if(DeltaCntEncoder2 > 0)
		CM_PER_CNT_2 = POS_CM_PER_CNT_2;	//转换为码盘 1 走过的路程
	else
		CM_PER_CNT_2 = NEG_CM_PER_CNT_2;	//转换为码盘 1 走过的路程
	
	course_delta_1 = CM_PER_CNT_1 * ((float)(DeltaCntEncoder1));	//转换为码盘 1 走过的路程
	course_delta_2 = CM_PER_CNT_2 * ((float)(DeltaCntEncoder2));	//转换为码盘 1 走过的路程
	course_sum_1 = CM_PER_CNT_1 * ((float)(Position_Now.Sum_Encoder1));
	course_sum_2 = CM_PER_CNT_2 * ((float)(Position_Now.Sum_Encoder2));
	
	Position_Now.Sum_Encoder1	+= DeltaCntEncoder1;			//增量式更新码盘 1 走过的总路程
	Position_Now.Sum_Encoder2	+= DeltaCntEncoder2;			//增量式更新码盘 2 走过的总路程
		
	Angle1 = Angle_XX + AngleDeg_HuDu;
	Angle1_cos = cos(Angle1);
	Angle1_sin = sin(Angle1);
	Angle2 = Angle_XX + AngleDeg_HuDu + mp_angle_wrong;
	Angle2_sin = sin(Angle2);
	Angle2_cos = cos(Angle2);	
	
	if(fabs(Angle_delta) < 0.0008) //直线更新,仅平动
	{
		x_del += course_delta_1*Angle1_cos - course_delta_2*Angle2_sin;
		y_del += course_delta_1*Angle1_sin + course_delta_2*Angle2_cos;
	}
	else
	{		
		Angle1_del = Angle1 + Angle_delta;
		Angle2_del = Angle2 + Angle_delta;
		Angle1_del_sin = sin(Angle1_del);
		Angle1_del_cos = cos(Angle1_del);
		Angle2_del_sin = sin(Angle2_del);
		Angle2_del_cos = cos(Angle2_del);
		
		x_del += (course_delta_1 * (Angle1_del_sin - Angle1_sin) + course_delta_2 * (Angle2_del_cos - Angle2_cos)) / (2 * sin(Angle_delta/2));	
		y_del += (-course_delta_1 * (Angle1_del_cos - Angle1_cos) + course_delta_2 * (Angle2_del_sin - Angle2_sin)) / (2 * sin(Angle_delta/2));
	
//
		
		
	}      
//	K1 = arc_K1 - (-93.079559);//-93.1);
//	K2 = arc_K2 - (23.658180);//23.61818);
//	
//	msg_Angle_OO = atan(K2 / K1);
//	msg_OO_distance = sqrt(K1 * K1 + K2 * K2) / 2;
}


void CountSpeed(void)	//第一个速度值不要
{	
	float X_del,Y_del;
	float temp,temp_sin,temp_cos,ticks;	//用于寄存公用的三角函数运算值，减少重复计算	
	
	ticks = OSTimeGet();
	time = (float)ticks/10000.0f;    //tick_ms强制转化为float类型
	time_det = time - time_last;
	time_last = time;	
	
	Position_Now.X += x_del;
	Position_Now.Y += y_del; 

	temp = (Position_Now.AngleDeg)*PI/180+Angle_OO;
	temp_cos = cos(temp);
	temp_sin = sin(temp);
	
	Position_Last.X = Position.X;
	Position_Last.Y = Position.Y;
	Position.X = Position_Now.X - OO_distance*temp_cos;					//车的位置x坐标
	Position.Y = Position_Now.Y - OO_distance*temp_sin;					//车的位置y坐标
	Position.AngleDeg = Position_Now.AngleDeg;							//1ms 更新一次坐标
	
	X_del = Position.X - Position_Last.X;								//小车坐标增量
	Y_del = Position.Y - Position_Last.Y;
	
	Speed_Now.Vx = KAL_filter(&kalman_Vx,(double)(X_del/time_det));
	Speed_Now.Vy = KAL_filter(&kalman_Vy,(double)(Y_del/time_det));
	Speed_Now.Vw = KAL_filter(&kalman_Vw,(double)(a_del/time_det));
	Speed_Now.V = sqrt(Speed_Now.Vx*Speed_Now.Vx + Speed_Now.Vy*Speed_Now.Vy);
	Accelerated_Speed = KAL_filter(&kalman_Accelerate,(double)((speed_Vnow-speed_Vlast)/time_det));
  
	speed_Vlast = speed_Vnow;
	speed_Vnow = Speed_Now.V;
	
	x_del = 0;
	y_del = 0;
	a_del = 0;
}

void GYRO_Reset(void)
{
   __set_FAULTMASK(1); /*把FAULTMASK置位，即关闭所有的中断执行复位时不被中断打断*/
   NVIC_SystemReset();/*系统软件复位，配置好的外设寄存器也一起复位*/
}



