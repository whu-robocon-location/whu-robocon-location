# 1.调车

## 组间配合
1. 机械组装车要求
   （1)  稳定。两片滑块板子之间的间距足够大，间距太小车容易左右晃

   （2）平行。保证车的边缘和导轨边缘平行。有的限位板可能有很大的加工误差，比如孔打反了，这对限位有大影响。

   （3）原装钉，别乱铣板子然后配上奇奇怪怪的螺钉。从透明小盒子里拿尼龙套和螺钉。

      (4)  夹子四个都要装
   
2. 量模型

   * 码盘中心到小车轮系外接圆中心的连线距离L和夹角α

   * 小车旋转180°后坐标改变量x，y

   * 旋转半径R = sqrt（x^2 + y^2)

   * 小车x轴与码盘x轴的夹角β

   * 车和轴承的模型，算出舵轮需要转的角度。（找机构组把转轮子代码写好）若为全向轮，可以省略。

     **Note**：α和β先目测，以免出错

3. 文件准备

   * 代码
   * 表格
   * matlab
   * 示波器
   * 命名格式：日期-车



* ### 0.0 陀螺仪标定

---

1. 这一步优先级最高，要求在调车之前标定陀螺仪。
   
2. 使用陀螺仪拟合表开始做实验
   
   （1） 打开代码，找到代码使用的积分系数。理论上积分系数可以设置为1，只要保证调试的时候代码的积分系数和表格中使用的积分系数一致。

   （2）电机转角可能与360有差，以输入的电机转角为准。如359.9

   （3）利用散点图拟合转速和积分系数的关系，得到公式，并且将公式输入scale列中。

   （4）拉出角度分度尺，一般0.2，保证filted_rate要从0取到150都有对应的积分系数值。可以利用wps数据栏中的删除重复数据去掉重复的filted_rate项。

   （5）将excel的1500个数据加入逗号后输出，放入代码。

   （6）测试陀螺仪性能。
   
   

* ### 1.1导轨直线度标定
***
#### 定义
1. **可用距离d**：大于180cm，（对应小车脉冲数大于30000），起点和终点角度差小于0.1°的一段距离
2. **解算阈值angle_delta_max**：小车在可用距离段行进时，陀螺仪输出的最大角度
#### 实验流程
1. 导轨检查：
   滑块必须配套原装钉，否则重装。
   小车推动顺滑，否则检查场地卫生、导轨上油、擦去灰尘、滑块上珠子。
   
2. 小车检查

   在代码中修改从机械组获取的参数，接上码盘，保证码盘没有反接。

3. 得出解算阈值
   将小车从导轨起点推到终点，得到**解算阈值**，加入代码，并注释圆弧更新。

4. 导轨直线度检验：
   （1）每36cm记录一次角度变化值，选出**可用距离**。若无可用距离，选出角度小于0.1°的一段。
   （2）记录始末点，重复实验一次精度。目前只有VG103不太稳定，实验时要注意输出的角度。
***

* ### 1.2 联合标定表格预备
***
#### 定义
1. **脉冲误差限**：当码盘脉冲数为30000时，为保证实验精度，依据经验，码盘误差限为20。若码盘脉冲数不足30000，误差限可按比例缩放。
2. **联合标定表格**：含有两组解、正反轮径系数、误差处理的表格
3. **有效数据**：做四次实验取码盘脉冲数中位数，若四次实验中某一组的码盘脉冲数与中位数的差值在脉冲误差限内，则这一次实验数据有效。
#### 流程
1. 检查小车坐标系和对应参数。取消main中的position的注释，注释掉圆弧更新部分。
2. 确定小车坐标系。先推单轴，注意限位，注意正反推都是实验数据，一定要做至少四组才可以得到**有效数据**。推到点以后需要置零；单轴标完之后换边。
3. 检验β的值是否正确。将取整后的脉冲放入**联合标定数据栏**。
4. 积分步长和迭代次数根据收敛情况确定。积分步长与输入量数量级相当比较好
5. 检验。
   (优化方案)
   1. 寻找打断程序时可以自动输出现有值的办法；
   
   2. 利用matlab自带梯度下降函数。
   
   3. 限定**脉冲数**的数值波动，上下偏差5，最多偏差10
问题：如果要验证四个方向，会额外拆装一次车，是否有更好的替代方案？
***

* ### 1.3 圆弧标定

***
1. 检查程序中圆弧反算的部分：
   (1) K1 = arc_K1 - x ；K2 = arc_K2  - y；
   (2) L = sqrt(K1*K1 + K2*K2)/2 
   (3) 注释直线更新

2. 准备圆弧解算表格
   做四组数据，确保正转和反转的α和L均在某一个值上下偏移0.01左右

3. 实验
   先催促机械组装模型。轴承难装，大概会花半个小时。需要检查是否有轴向偏移量。
   由于转180°比较难控制，所以推的时候注意要尽量从远端推。
   jlink特别容易掉，要么换用jlink，要么检查兼容性。硬件一般不会出问题，如果是硬件接口松了，重接即可。

4. 数据处理
   将表格中数据放入circle_grad，以得到真实的xy偏移量。需要修改的参数在matlab注释中均有说明。如果收敛较快，在while里面打断点并在控制台输入fprinft函数对应的输出量，如vpa(circle)，即可实时查看几个参数的值。

5. 修改x，y值，重复步骤2，保证正转和反转α和L值不超过0.1和0.2（这个值目前还没有明确的标准）；否则，重复步骤2~3

6. 检验正转和反转时的实验效果，否则，重复步骤2~4，同时寻找正反转的阈值差。最多一米偏一毫米。

#### 标准
0. 第一次做实验前先验证陀螺仪，保证正转和反转的精度

1. 避免回程。
2. 每次实验AngleDegree与+-180的误差不超过0.01，推远端以控制。对于全为正转或反转的数据集，解算出的α（注意弧度转角度）角度差值和L差值相对于中值的误差小于0.01.
3. 每次实验做5组，方便取中位数。将各组数据平均数（因为各数据可信）放入matlab，对输出结果取均值。
4. 实验校核 正转反转，x，y相对误差必须小于0.1%左右
      验证时角度AngleDeg必须在179.99和180.01之间，正反各做两次，以防偶然情况。均值、正转、反转各做一组。                  
5. 如果未达到精度，且重复上述流程一次之后，仍然无法满足。考虑（1）提高角度精度到179.995~180.005.误差限二分法。
***




* ### 1.4 实验效果检验
***
1. 取消代码中圆弧的注释。
   
2. 推导轨运动，判断偏移量。采集四个方向的数据，丢进err_grad.m里。

3. 推导轨运动，再看偏移量。记录下最后一次优化后各个方向的误差，寻找是否有让梯度下降全局收敛的方法。
***

* ### 1.5 整理
***
1. 保存好代码备份。
   
2. 收好器件，保护好导轨。

***
